# Отчёт по передаче документов: `toir_tra_report_v1`

**Версия: v1**

> [!IMPORTANT]
> **Рекомендация по запуску**
>
> Лучше всего запускать программу (или скомпилированный `.exe` файл) в **отдельной, специально созданной для нее папке**.
> При первом запуске программа создаст рядом с собой файл настроек `settings.json` и папку `Template` с шаблонами. Хранение программы в отдельной папке поможет избежать смешивания этих служебных файлов с вашими проектами.

## 1. Назначение

- Формирует ведомость передачи документов (Transmittal) в Excel на основе выбранной папки и шаблонов CT (и не только).
- Подставляет текущую дату, настраивает печатную область, переносит строки и слияния.
- Ищет названия работ по индексам из `TZ.xlsx` (ТОИР), если не находит оставляет ячейку "Назив документа" пустой.
- Сохраняет итоговый Excel с автоинкрементом в имени и, по желанию, собирает ZIP с вложениями.
- ‎В папку Template можно добавлять другие шаблоны трансмиталлов, он автоматически подхватиться и будет искать по абривиатуре: GST,  CDT, CNE, TRE, ENK, SIM и тд.

  ![TOIR TRA Report](assets/image_toir_tra_report.png)

## 2. Использование (GUI)

1. Нажмите “Выбрать папку с документами…” и укажите папку с файлами.
2. **Быстрый доступ к папке**: После выбора папки ее имя появляется в статус-баре в виде ссылки. Нажмите на нее, чтобы открыть папку.
3. Выберите **статус** (из трёх доступных).
4. Выберите **компанию (шаблон)**:
   - Список строится по файлам `*.xltx` в подпапке выбранного статуса.
   - **Автоматический выбор шаблона**: Программа автоматически выбирает шаблон на основе имени папки. Правила поиска:
     1. Сначала ищется аббревиатура с префиксом: `_KSR` или `-KSR`.
        - *Пример:* `2025-09-09_KSR_документы`
     2. Если не найдено, ищется **аббревиатура как отдельное слово в верхнем регистре**.
        - *Пример:* `Отправка в KSR`
     3. Если совпадений нет, автоматически выбирается общий шаблон `(XXX) Общий` (если он доступен).
5. **Опции архивации**: можно создать ZIP с вложениями и (опционально) удалить исходные файлы после упаковки.
6. Нажмите “Сформировать отчет”. Итоговый Excel и ZIP (если выбран) появятся в целевой папке.
7. **Вкладка "Формирование папок"**: позволяет выбрать каталоги источника и назначения, автоматически группирует документы по индексам и формирует папки на базе `TZ_glob.xlsx`. Вкладка содержит три кнопки: выбор входной папки, выбор выходной папки и запуск обработки.

## 3. Файл `TZ.xlsx`

Этот файл используется для получения полного названия документа по его индексу (который берется из имени файла).

### Структура `TZ.xlsx`

Вы можете значительно упростить этот файл, оставив только **две необходимые колонки**:

- **Колонка с индексом документа:** Может находиться в любом месте в пределах первых 20 колонок (например, в колонке **A**).
- **Колонка `C` с названием документа:** Это **самое надежное место**. Скрипт ищет название в первую очередь здесь.

> [!NOTE]
> Если колонка `C` будет пустой, скрипт попытается найти название в ячейках справа от найденного индекса. Однако для предсказуемой работы рекомендуется всегда использовать колонку `C` для названий.

**Пример минимальной структуры `TZ.xlsx`:**

| A (Индекс) | B (Пусто) | C (Название документа) |
| :--------------- | :------------- | :-------------------------------------- |
| I.1.a            |                | Схема подключения       |
| XI.2.5.b         |                | План расположения       |

## 4. Настройки (`settings.json`) и кастомные шаблоны

Файл `settings.json` создается рядом с программой и **не перезаписывается** при последующих запусках. Вы можете безопасно вносить в него изменения.

- **`templates_path`**: Позволяет указать **путь к вашей собственной папке с шаблонами**.
  - **Как использовать**: В меню программы выберите `Настройки` -> `Указать папку с шаблонами...` и выберите папку, внутри которой лежит ваша папка `Template`.
  - Программа сохранит этот путь, и при следующих запусках будет использовать шаблоны из указанного вами места, а не из папки `Template` рядом с `.exe`.
  - Если путь не указан, используются шаблоны из папки `Template` по умолчанию.
- **`company_names`**: Словарь для связи аббревиатур (`GST`) и полных названий компаний (`Gastrans`).

## 5. Расположение файлов

- Скрипт: `toir_tra_report/toir_tra_report_v1.py`
- Этот документ: `toir_tra_report/toir_tra_report.md`
- Настройки: `toir_tra_report/settings.json`
- Шаблоны: `<TEMPLATES_ROOT>/Template/template_tra/<status>/CT-<ABBR>-TRA-PRM-Template.xltx`

## 6. Сборка `.exe` файла

Для создания исполняемого `.exe` файла используется PyInstaller.

### Команда для сборки

Выполните эту команду в корневой папке проекта:

```bash
pyinstaller --onefile --windowed --name toir_tra_report_v1 --add-data "toir_tra_report/Template;Template" toir_tra_report/toir_tra_report_v1.py
pyinstaller --onefile --windowed --name toir_tra_report_v1 --icon=assets/icon_toir_tra_report.ico --add-data "toir_tra_report/Template;Template" toir_tra_report/toir_tra_report_v1.py
```

### Поведение `.exe`

- **Первый запуск**: `.exe` файл автоматически создаст **рядом с собой** файл `settings.json` и папку `Template` со всей структурой.
- **Последующие запуски**: Программа будет использовать именно эти, "внешние" `settings.json` и `Template`. Это позволяет сохранять ваши настройки и изменения в шаблонах.
