# AGENTS

## Назначение проекта
- `toir_tra_report` — настольное приложение на Tkinter для подготовки пакетов документов ТОиР.
- Основные сценарии: генерация Excel-писем (`CT-*-TRA-PRM-*.xlsx`), формирование индексных папок для `CT-DR-*`, выпуск CMM-комментариев по шаблону.
- Рабочий справочник данных: `Template/TZ_glob.xlsx`; пользовательские пути и компании — `settings.json`.

## Архитектура (слои)
1. `core` — чистая логика, без I/O (здесь располагаем функции обработки индексов, трансформации данных).
2. `services` — интеграции с файлами/Excel/ФС, работающие поверх core.
3. `ui/cli` — пользовательский интерфейс (`toir_tra_report_v1.py`), использующий слои ниже.

## Документация и версии
- Источник правды по версиям и публичному поведению: `CHANGELOG.md`.
- Руководство пользователя и сценарии: `README.md`.
- При любом изменении публичного API/CLI/форматов:
  1. Обновить примеры и параметры в `README.md`.
  2. Добавить запись в `CHANGELOG.md` (формат Keep a Changelog).
  3. Повысить SemVer (патч/минор/мажор) и синхронизировать в README.
- Для внутренних правок (рефакторинг без изменения контрактов) запись в `CHANGELOG.md` опциональна, но рекомендуется.

## Процесс разработки
- Команды выполняются в виртуальном окружении (`python -m venv .venv`; `pip install -r requirements.txt`).
- Патчи не выкладываем в чат — сохраняем в `patches/{timestamp}-{slug}.diff`.
- Pull Request checklist: README ✅ / CHANGELOG ✅ / SemVer ✅ / Tests ✅ / AGENTS.md (при изменении правил) ✅.
- Версия приложения для сборки: PyInstaller-спеки `toir_tra_report_v2.7.spec` (обновлять при bump версии).

## Quality Gates (обязательные)
| Команда            | Назначение                    |
|--------------------|--------------------------------|
| `ruff check .`     | линтер                        |
| `black --check .`  | контроль форматирования       |
| `mypy .`           | статический анализ (нужны stubs, напр. `types-openpyxl`) |
| `pytest -q`        | тесты (`tests/`)              |

## Рабочие каталоги и артефакты
- `Template/` — распределяемые шаблоны; при изменении структуры обновляем README/CHANGELOG.
- `index_folder_builder.py` — логика группировки индексных папок, использует колонки B/E/H/G `TZ_glob.xlsx`.
- `cmm_builder.py` — генерация CMM-отчётов.
- `tests/test_index_folder_builder.py` — проверяет сценарии группировки; при обновлении правил добавлять или корректировать тесты.

## Безопасность и данные
- Любой ввод (пути, Excel) считать недостоверным: проверять существование каталогов, фильтровать имена файлов.
- SQL не используется; при добавлении БД — только параметризованные запросы/ORM.
- Хранение секретов исключительно через переменные окружения/секрет-менеджер; `settings.json` без чувствительных данных.

## Коммуникации и дорожная карта
- Долгосрочные задачи: `docs/ROADMAP.md` (если файл отсутствует — создать перед ведением).
- Основной канал обратной связи — команда ТОиР (см. README).

## Удалённые / устаревшие файлы
- `GEMINI.md` удалён как дубль `CHANGELOG.md`. Актуальную историю версий вести только в `CHANGELOG.md`.
